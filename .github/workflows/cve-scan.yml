# ──────────────────────────────────────────────────────────────
# CVE-Scan – Täglicher Sicherheits-Scan der Abhängigkeiten
# ──────────────────────────────────────────────────────────────
# Scannt JavaScript-CDN- und Python-Abhängigkeiten gegen die
# Google OSV API und committet den Report zurück ins Repository.
# Bei CVSS >= 7.0 wird ein GitHub Issue als Alert erstellt.
# Benachrichtigung erfolgt über GitHub Notifications (keine
# SMTP-Secrets erforderlich).
#
# Trigger: Täglich 06:00 UTC  |  Manuell via workflow_dispatch
# ──────────────────────────────────────────────────────────────

name: CVE-Scan

on:
  schedule:
    # Täglich um 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:   # Manueller Start über GitHub UI

permissions:
  contents: write      # Für git push der Reports
  issues: write        # Für GitHub Issue Alert

jobs:
  cve-scan:
    runs-on: ubuntu-latest
    steps:

      # ── 1. Repository auschecken ──
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      # ── 2. Python einrichten ──
      - name: Python 3.12 einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ── 3. Scanner-Abhängigkeiten installieren ──
      - name: Scanner-Abhängigkeiten installieren
        run: pip install -r security/requirements.txt

      # ── 4. CVE-Scan ausführen ──
      - name: CVE-Scan ausführen
        id: scan
        run: |
          python security/cve_scanner.py || true
          # Exit-Code 1 = Schwachstellen gefunden (kein Workflow-Fehler)

      # ── 5. Report ins Repository committen ──
      - name: Report committen
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p security/reports
          git add -f security/reports/ || echo "Nichts zum Adden."
          # Nur committen, wenn sich etwas geändert hat
          git diff --cached --quiet && echo "Keine Änderungen." && exit 0
          git commit -m "security: CVE-Scan Report $(date -u +%Y-%m-%d)"
          git push

      # ── 6. GitHub Issue Alert bei CVSS >= 7.0 ──
      - name: Issue-Alert bei kritischen CVEs
        if: steps.scan.outputs.high_severity == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO_FULL: ${{ github.repository }}
          HIGH_COUNT: ${{ steps.scan.outputs.high_count }}
        run: |
          set -e
          DATE=$(date -u +%Y-%m-%d)
          TITLE="⚠️ CVE-Alert: ${HIGH_COUNT} kritische Schwachstelle(n) (${DATE})"

          # Label anlegen falls noch nicht vorhanden
          gh label create "cve-alert" \
            --description "CVE-Alert: Kritische Schwachstelle (CVSS >= 7.0)" \
            --color "d73a4a" 2>/dev/null || true

          # Prüfen ob heute bereits ein Issue existiert (Duplikat-Schutz)
          EXISTING=$(gh issue list \
            --label "cve-alert" \
            --search "${DATE}" \
            --state open \
            --json number --jq 'length' 2>/dev/null || echo "0")
          if [ "$EXISTING" -gt "0" ]; then
            echo "Issue für heute existiert bereits – übersprungen."
            exit 0
          fi

          # Issue-Body zusammenbauen (ohne Heredoc)
          {
            if [ -f security/reports/alert_high_severity.txt ]; then
              cat security/reports/alert_high_severity.txt
            else
              echo "${HIGH_COUNT} Schwachstelle(n) mit CVSS >= 7.0 gefunden. Details: security/reports/cve_report.md"
            fi
            echo ""
            echo "---"
            echo "**Report:** [cve_report.md](https://github.com/${REPO_FULL}/blob/main/security/reports/cve_report.md)"
            echo "*Automatisch erstellt von GitHub Actions (CVE-Scan Workflow).*"
          } > /tmp/issue_body.md

          # Issue erstellen: mit Assignee versuchen, Fallback ohne
          ISSUE_URL=$(
            gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md \
              --label "cve-alert" \
              --assignee "Bheowulf" 2>/dev/null \
            || gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md \
              --label "cve-alert" 2>/dev/null \
            || gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md
          )
          echo "✅ Issue erstellt: ${ISSUE_URL}"
