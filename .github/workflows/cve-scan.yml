# ──────────────────────────────────────────────────────────────
# CVE-Scan – Täglicher Sicherheits-Scan der Abhängigkeiten
# ──────────────────────────────────────────────────────────────
# Scannt JavaScript-CDN- und Python-Abhängigkeiten gegen die
# Google OSV API und committet den Report zurück ins Repository.
#
# Trigger: Täglich 06:00 UTC  |  Manuell via workflow_dispatch
# ──────────────────────────────────────────────────────────────

name: CVE-Scan

on:
  schedule:
    # Täglich um 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:   # Manueller Start über GitHub UI

permissions:
  contents: write      # Für git push der Reports

jobs:
  cve-scan:
    runs-on: ubuntu-latest
    steps:

      # ── 1. Repository auschecken ──
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      # ── 2. Python einrichten ──
      - name: Python 3.12 einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ── 3. Scanner-Abhängigkeiten installieren ──
      - name: Scanner-Abhängigkeiten installieren
        run: pip install -r security/requirements.txt

      # ── 4. CVE-Scan ausführen ──
      - name: CVE-Scan ausführen
        id: scan
        run: |
          python security/cve_scanner.py || true
          # Exit-Code 1 = Schwachstellen gefunden (kein Workflow-Fehler)

      # ── 5. Report ins Repository committen ──
      - name: Report committen
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add security/reports/
          # Nur committen, wenn sich etwas geändert hat
          git diff --cached --quiet && echo "Keine Änderungen." && exit 0
          git commit -m "security: CVE-Scan Report $(date -u +%Y-%m-%d)"
          git push
