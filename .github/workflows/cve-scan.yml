# ──────────────────────────────────────────────────────────────
# CVE-Scan – Täglicher Sicherheits-Scan der Abhängigkeiten
# ──────────────────────────────────────────────────────────────
# Scannt JavaScript-CDN- und Python-Abhängigkeiten gegen die
# Google OSV API und committet den Report zurück ins Repository.
# Bei CVSS >= 7.0 wird ein Email-Alert versendet.
#
# Trigger: Täglich 06:00 UTC  |  Manuell via workflow_dispatch
#
# Benötigte Repository-Secrets:
#   SMTP_SERVER   – SMTP-Host       (z.B. smtp.office365.com)
#   SMTP_PORT     – SMTP-Port       (z.B. 587)
#   SMTP_USERNAME – Absender-Login  (z.B. noreply@de.schunk.com)
#   SMTP_PASSWORD – Absender-Passwort / App-Passwort
# ──────────────────────────────────────────────────────────────

name: CVE-Scan

on:
  schedule:
    # Täglich um 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:   # Manueller Start über GitHub UI

permissions:
  contents: write      # Für git push der Reports

jobs:
  cve-scan:
    runs-on: ubuntu-latest
    steps:

      # ── 1. Repository auschecken ──
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      # ── 2. Python einrichten ──
      - name: Python 3.12 einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ── 3. Scanner-Abhängigkeiten installieren ──
      - name: Scanner-Abhängigkeiten installieren
        run: pip install -r security/requirements.txt

      # ── 4. CVE-Scan ausführen ──
      - name: CVE-Scan ausführen
        id: scan
        run: |
          python security/cve_scanner.py || true
          # Exit-Code 1 = Schwachstellen gefunden (kein Workflow-Fehler)

      # ── 5. Report ins Repository committen ──
      - name: Report committen
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add security/reports/
          # Nur committen, wenn sich etwas geändert hat
          git diff --cached --quiet && echo "Keine Änderungen." && exit 0
          git commit -m "security: CVE-Scan Report $(date -u +%Y-%m-%d)"
          git push

      # ── 6. Email-Alert bei CVSS >= 7.0 ──
      - name: Email-Alert bei kritischen CVEs
        if: steps.scan.outputs.high_severity == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.scan.outputs.alert_subject }}
          to: nico.peper@de.schunk.com
          from: TARATool CVE-Scanner <${{ secrets.SMTP_USERNAME }}>
          body: |
            ${{ steps.scan.outputs.high_count }} Schwachstelle(n) mit CVSS >= 7.0 in TARATool-Abhängigkeiten gefunden.

            Vollständiger Report:
            https://github.com/SCHUNK-SE-Co-KG/TARATool/blob/main/security/reports/cve_report.md

            ---
            Automatisch generiert von GitHub Actions (CVE-Scan Workflow).
          content_type: text/plain
