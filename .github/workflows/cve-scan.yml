# ──────────────────────────────────────────────────────────────
# CVE-Scan – Täglicher Sicherheits-Scan der Abhängigkeiten
# ──────────────────────────────────────────────────────────────
# Scannt JavaScript-CDN- und Python-Abhängigkeiten gegen die
# Google OSV API und committet den Report zurück ins Repository.
# Bei CVSS >= 7.0 wird ein GitHub Issue als Alert erstellt.
# Benachrichtigung erfolgt über GitHub Notifications (keine
# SMTP-Secrets erforderlich).
#
# Trigger: Täglich 06:00 UTC  |  Manuell via workflow_dispatch
# ──────────────────────────────────────────────────────────────

name: CVE-Scan

on:
  schedule:
    # Täglich um 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:   # Manueller Start über GitHub UI

permissions:
  contents: write      # Für git push der Reports
  issues: write        # Für GitHub Issue Alert

jobs:
  cve-scan:
    runs-on: ubuntu-latest
    steps:

      # ── 1. Repository auschecken ──
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      # ── 2. Python einrichten ──
      - name: Python 3.12 einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ── 3. Scanner-Abhängigkeiten installieren ──
      - name: Scanner-Abhängigkeiten installieren
        run: pip install -r security/requirements.txt

      # ── 4. CVE-Scan ausführen ──
      - name: CVE-Scan ausführen
        id: scan
        run: |
          python security/cve_scanner.py || true
          # Exit-Code 1 = Schwachstellen gefunden (kein Workflow-Fehler)

      # ── 5. Report ins Repository committen ──
      - name: Report committen
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add security/reports/
          # Nur committen, wenn sich etwas geändert hat
          git diff --cached --quiet && echo "Keine Änderungen." && exit 0
          git commit -m "security: CVE-Scan Report $(date -u +%Y-%m-%d)"
          git push

      # ── 6. GitHub Issue Alert bei CVSS >= 7.0 ──
      - name: Issue-Alert bei kritischen CVEs
        if: steps.scan.outputs.high_severity == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          TITLE="⚠️ CVE-Alert: ${{ steps.scan.outputs.high_count }} kritische Schwachstelle(n) (${DATE})"

          # Prüfen ob heute bereits ein Issue existiert (Duplikat-Schutz)
          EXISTING=$(gh issue list --label "cve-alert" --search "${DATE}" --state open --json number --jq 'length')
          if [ "$EXISTING" -gt "0" ]; then
            echo "Issue für heute existiert bereits – übersprungen."
            exit 0
          fi

          # Alert-Datei als Issue-Body verwenden
          if [ -f security/reports/alert_high_severity.txt ]; then
            BODY=$(cat security/reports/alert_high_severity.txt)
          else
            BODY="${{ steps.scan.outputs.high_count }} Schwachstelle(n) mit CVSS >= 7.0 gefunden. Details: security/reports/cve_report.md"
          fi

          # Issue erstellen + @mention für Benachrichtigung
          gh issue create \
            --title "${TITLE}" \
            --body "${BODY}

          ---
          **Assignee:** @Bheowulf
          **Report:** [cve_report.md](https://github.com/${{ github.repository }}/blob/main/security/reports/cve_report.md)
          *Automatisch erstellt von GitHub Actions (CVE-Scan Workflow).*" \
            --label "cve-alert" \
            --assignee "Bheowulf"
