# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# CVE Monthly Report ‚Äì Monatlicher Sicherheitsbericht
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Erstellt am 1. Montag jedes Monats um 09:00 Uhr (MEZ/MESZ)
# ein GitHub Issue mit dem vollst√§ndigen CVE-Report.
#
# Trigger: 1. Montag im Monat 08:00 UTC (= 09:00 MEZ)
#          Manuell via workflow_dispatch
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

name: CVE Monthly Report

on:
  schedule:
    # Jeden Montag um 08:00 UTC (09:00 MEZ) ‚Äì Step pr√ºft ob 1. Montag
    - cron: "0 8 * * 1"
  workflow_dispatch:   # Manueller Start √ºber GitHub UI

permissions:
  contents: write     # F√ºr git push der Reports
  issues: write

jobs:
  monthly-report:
    runs-on: ubuntu-latest
    steps:

      # ‚îÄ‚îÄ 1. Pr√ºfen ob 1. Montag im Monat (oder manuell) ‚îÄ‚îÄ
      - name: Pr√ºfe ob 1. Montag im Monat
        id: check
        run: |
          DAY=$(date -u +%d)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manueller Start ‚Äì Report wird erstellt."
            echo "skip=false" >> $GITHUB_OUTPUT
          elif [ "$DAY" -le "7" ]; then
            echo "1. Montag im Monat ‚Äì Report wird erstellt."
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "Nicht der 1. Montag ‚Äì √ºbersprungen."
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      # ‚îÄ‚îÄ 2. Repository auschecken ‚îÄ‚îÄ
      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: main

      # ‚îÄ‚îÄ 3. Python + Scanner ausf√ºhren (frische Daten) ‚îÄ‚îÄ
      - name: Python 3.12 einrichten
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Scanner-Abh√§ngigkeiten installieren
        if: steps.check.outputs.skip != 'true'
        run: pip install -r security/requirements.txt

      - name: CVE-Scan ausf√ºhren (frische Daten f√ºr Report)
        if: steps.check.outputs.skip != 'true'
        run: python security/cve_scanner.py || true

      - name: Report committen
        if: steps.check.outputs.skip != 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f security/reports/
          git diff --cached --quiet && echo "Keine √Ñnderungen." && exit 0
          git commit -m "security: CVE Monthly Report $(date -u +%Y-%m-%d)"
          git push

      # ‚îÄ‚îÄ 4. Monatlichen Report als GitHub Issue erstellen ‚îÄ‚îÄ
      - name: Monthly Report Issue erstellen
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO_FULL: ${{ github.repository }}
        run: |
          set -e
          MONTH=$(date -u +"%B %Y")
          DATE=$(date -u +%Y-%m-%d)
          TITLE="üìã CVE Monthly Report ‚Äì ${MONTH}"

          # Label anlegen falls noch nicht vorhanden
          gh label create "cve-monthly-report" \
            --description "Monatlicher CVE-Sicherheitsbericht" \
            --color "0075ca" 2>/dev/null || true

          # Duplikat-Schutz: pr√ºfen ob diesen Monat schon ein Report existiert
          YEAR_MONTH=$(date -u +"%Y-%m")
          EXISTING=$(gh issue list \
            --label "cve-monthly-report" \
            --search "${YEAR_MONTH}" \
            --state all \
            --json number --jq 'length' 2>/dev/null || echo "0")
          if [ "$EXISTING" -gt "0" ]; then
            echo "Monthly Report f√ºr ${MONTH} existiert bereits ‚Äì √ºbersprungen."
            exit 0
          fi

          # Issue-Body zusammenbauen (ohne Heredoc)
          {
            echo "# Monatlicher CVE-Sicherheitsbericht"
            echo ""
            echo "**Berichtszeitraum:** ${MONTH}"
            echo "**Erstellt am:** ${DATE}"
            echo "**Quelle:** T√§glicher CVE-Scan via OSV API"
            echo ""
            echo "---"
            echo ""
            if [ -f security/reports/cve_report.md ]; then
              cat security/reports/cve_report.md
            else
              echo "‚ö†Ô∏è Kein CVE-Report vorhanden. Bitte den t√§glichen CVE-Scan pr√ºfen."
            fi
            echo ""
            echo "---"
            echo ""
            echo "*Automatisch erstellt von GitHub Actions (CVE Monthly Report Workflow).*"
            echo "*Vollst√§ndiger Report: [cve_report.md](https://github.com/${REPO_FULL}/blob/main/security/reports/cve_report.md)*"
          } > /tmp/issue_body.md

          # Issue erstellen (--assignee kann fehlschlagen wenn User kein Collaborator)
          gh issue create \
            --title "${TITLE}" \
            --body-file /tmp/issue_body.md \
            --label "cve-monthly-report" || {
              echo "‚ö†Ô∏è Issue-Erstellung fehlgeschlagen. Versuche ohne Label..."
              gh issue create \
                --title "${TITLE}" \
                --body-file /tmp/issue_body.md
            }
