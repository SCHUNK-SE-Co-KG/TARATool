# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# CVE Monthly Report ‚Äì Monatlicher Sicherheitsbericht
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Erstellt am 1. Montag jedes Monats um 09:00 Uhr (MEZ/MESZ)
# ein GitHub Issue mit dem vollst√§ndigen CVE-Report.
#
# Trigger: 1. Montag im Monat 08:00 UTC (= 09:00 MEZ)
#          Manuell via workflow_dispatch
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

name: CVE Monthly Report

on:
  schedule:
    # Jeden Montag um 08:00 UTC (09:00 MEZ) ‚Äì Step pr√ºft ob 1. Montag
    - cron: "0 8 * * 1"
  workflow_dispatch:   # Manueller Start √ºber GitHub UI

permissions:
  contents: read
  issues: write

jobs:
  monthly-report:
    runs-on: ubuntu-latest
    steps:

      # ‚îÄ‚îÄ 1. Pr√ºfen ob 1. Montag im Monat (oder manuell) ‚îÄ‚îÄ
      - name: Pr√ºfe ob 1. Montag im Monat
        id: check
        run: |
          DAY=$(date -u +%d)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manueller Start ‚Äì Report wird erstellt."
            echo "skip=false" >> $GITHUB_OUTPUT
          elif [ "$DAY" -le "7" ]; then
            echo "1. Montag im Monat ‚Äì Report wird erstellt."
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "Nicht der 1. Montag ‚Äì √ºbersprungen."
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      # ‚îÄ‚îÄ 2. Repository auschecken ‚îÄ‚îÄ
      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: main

      # ‚îÄ‚îÄ 3. Monatlichen Report als GitHub Issue erstellen ‚îÄ‚îÄ
      - name: Monthly Report Issue erstellen
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          MONTH=$(date -u +"%B %Y")
          DATE=$(date -u +%Y-%m-%d)
          TITLE="üìã CVE Monthly Report ‚Äì ${MONTH}"

          # Duplikat-Schutz: pr√ºfen ob diesen Monat schon ein Report existiert
          YEAR_MONTH=$(date -u +"%Y-%m")
          EXISTING=$(gh issue list --label "cve-monthly-report" --search "${YEAR_MONTH}" --state all --json number --jq 'length')
          if [ "$EXISTING" -gt "0" ]; then
            echo "Monthly Report f√ºr ${MONTH} existiert bereits ‚Äì √ºbersprungen."
            exit 0
          fi

          # Report-Datei lesen
          if [ -f security/reports/cve_report.md ]; then
            REPORT=$(cat security/reports/cve_report.md)
          else
            REPORT="‚ö†Ô∏è Kein CVE-Report vorhanden. Bitte den t√§glichen CVE-Scan pr√ºfen."
          fi

          # Issue erstellen
          gh issue create \
            --title "${TITLE}" \
            --body "# Monatlicher CVE-Sicherheitsbericht

          **Berichtszeitraum:** ${MONTH}
          **Erstellt am:** ${DATE}
          **Quelle:** T√§glicher CVE-Scan via OSV API

          ---

          ${REPORT}

          ---
          **Assignee:** @Bheowulf
          *Automatisch erstellt von GitHub Actions (CVE Monthly Report Workflow).*
          *Vollst√§ndiger Report: [cve_report.md](https://github.com/${{ github.repository }}/blob/main/security/reports/cve_report.md)*" \
            --label "cve-monthly-report" \
            --assignee "Bheowulf"
