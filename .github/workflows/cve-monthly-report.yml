# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CVE Monthly Report â€“ Monatlicher Sicherheitsbericht
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Erstellt am 1. Montag jedes Monats um 09:00 Uhr (MEZ/MESZ)
# ein GitHub Issue mit dem vollstÃ¤ndigen CVE-Report.
#
# Trigger: 1. Montag im Monat 08:00 UTC (= 09:00 MEZ)
#          Manuell via workflow_dispatch
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: CVE Monthly Report

on:
  schedule:
    # Jeden Montag um 08:00 UTC (09:00 MEZ) â€“ Step prÃ¼ft ob 1. Montag
    - cron: "0 8 * * 1"
  workflow_dispatch:   # Manueller Start Ã¼ber GitHub UI

permissions:
  contents: write     # FÃ¼r git push der Reports
  issues: write

jobs:
  monthly-report:
    runs-on: ubuntu-latest
    steps:

      # â”€â”€ 1. PrÃ¼fen ob 1. Montag im Monat (oder manuell) â”€â”€
      - name: PrÃ¼fe ob 1. Montag im Monat
        id: check
        run: |
          DAY=$(date -u +%d)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manueller Start â€“ Report wird erstellt."
            echo "skip=false" >> $GITHUB_OUTPUT
          elif [ "$DAY" -le "7" ]; then
            echo "1. Montag im Monat â€“ Report wird erstellt."
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "Nicht der 1. Montag â€“ Ã¼bersprungen."
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ 2. Repository auschecken â”€â”€
      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: main

      # â”€â”€ 3. Python + Scanner ausfÃ¼hren (frische Daten) â”€â”€
      - name: Python 3.12 einrichten
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Scanner-AbhÃ¤ngigkeiten installieren
        if: steps.check.outputs.skip != 'true'
        run: pip install -r security/requirements.txt

      - name: CVE-Scan ausfÃ¼hren (frische Daten fÃ¼r Report)
        if: steps.check.outputs.skip != 'true'
        run: python security/cve_scanner.py || true

      - name: Report committen
        if: steps.check.outputs.skip != 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p security/reports
          git add -f security/reports/ || echo "Nichts zum Adden."
          git diff --cached --quiet && echo "Keine Ã„nderungen." && exit 0
          git commit -m "security: CVE Monthly Report $(date -u +%Y-%m-%d)"
          git push

      # â”€â”€ 4. Monatlichen Report als GitHub Issue erstellen â”€â”€
      - name: Monthly Report Issue erstellen
        if: steps.check.outputs.skip != 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
          REPO_FULL: ${{ github.repository }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          MONTH=$(date -u +"%B %Y")
          DATE=$(date -u +%Y-%m-%d)
          TITLE="ðŸ“‹ CVE Monthly Report â€“ ${MONTH}"

          # Label anlegen falls noch nicht vorhanden
          gh label create "cve-monthly-report" \
            --description "Monatlicher CVE-Sicherheitsbericht" \
            --color "0075ca" 2>/dev/null || true

          # Duplikat-Schutz nur bei Schedule-Runs (manuell immer erlauben)
          if [ "$EVENT_NAME" != "workflow_dispatch" ]; then
            YEAR_MONTH=$(date -u +"%Y-%m")
            EXISTING=$(gh issue list \
              --label "cve-monthly-report" \
              --search "${YEAR_MONTH}" \
              --state all \
              --json number --jq 'length' 2>/dev/null || echo "0")
            if [ "$EXISTING" -gt "0" ]; then
              echo "Monthly Report fÃ¼r ${MONTH} existiert bereits â€“ Ã¼bersprungen."
              exit 0
            fi
          else
            echo "Manueller Start â€“ Duplikat-Schutz Ã¼bersprungen."
          fi

          # Issue-Body zusammenbauen
          {
            echo "# ðŸ“‹ Monatlicher CVE-Sicherheitsbericht"
            echo ""
            echo "**Berichtszeitraum:** ${MONTH}"
            echo "**Erstellt am:** ${DATE}"
            echo "**Quelle:** CVE-Scan via OSV API"
            echo ""
            echo "---"
            echo ""
            if [ -f security/reports/cve_report.md ]; then
              cat security/reports/cve_report.md
            else
              echo "âš ï¸ Kein CVE-Report vorhanden. Bitte den tÃ¤glichen CVE-Scan prÃ¼fen."
            fi
            echo ""
            echo "---"
            echo ""
            echo "*Automatisch erstellt von GitHub Actions (CVE Monthly Report Workflow).*"
            echo "*VollstÃ¤ndiger Report: [cve_report.md](https://github.com/${REPO_FULL}/blob/main/security/reports/cve_report.md)*"
          } > /tmp/issue_body.md

          echo "Issue-Body erstellt ($(wc -c < /tmp/issue_body.md) Bytes)"

          # Issue erstellen: mit Assignee versuchen, Fallback ohne
          ISSUE_URL=$(
            gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md \
              --label "cve-monthly-report" \
              --assignee "Bheowulf" 2>/dev/null \
            || gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md \
              --label "cve-monthly-report" 2>/dev/null \
            || gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md
          )
          echo "âœ… Issue erstellt: ${ISSUE_URL}"
