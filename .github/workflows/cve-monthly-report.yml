# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CVE Monthly Report â€“ Monatlicher Sicherheitsbericht
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Erstellt am 1. Montag jedes Monats um 09:00 Uhr (MEZ/MESZ)
# ein GitHub Issue mit dem vollstÃ¤ndigen CVE-Report.
#
# Trigger: 1. Montag im Monat 08:00 UTC (= 09:00 MEZ)
#          Manuell via workflow_dispatch
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: CVE Monthly Report

on:
  schedule:
    # Jeden Montag um 08:00 UTC (09:00 MEZ) â€“ Step prÃ¼ft ob 1. Montag
    - cron: "0 8 * * 1"
  workflow_dispatch:   # Manueller Start Ã¼ber GitHub UI

permissions:
  contents: read
  issues: write

jobs:
  monthly-report:
    runs-on: ubuntu-latest
    steps:

      # â”€â”€ 1. PrÃ¼fen ob 1. Montag im Monat (oder manuell) â”€â”€
      - name: PrÃ¼fe ob 1. Montag im Monat
        id: check
        run: |
          DAY=$(date -u +%d)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manueller Start â€“ Report wird erstellt."
            echo "skip=false" >> $GITHUB_OUTPUT
          elif [ "$DAY" -le "7" ]; then
            echo "1. Montag im Monat â€“ Report wird erstellt."
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "Nicht der 1. Montag â€“ Ã¼bersprungen."
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ 2. Repository auschecken â”€â”€
      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: main

      # â”€â”€ 3. Monatlichen Report als GitHub Issue erstellen â”€â”€
      - name: Monthly Report Issue erstellen
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          MONTH=$(date -u +"%B %Y")
          DATE=$(date -u +%Y-%m-%d)
          TITLE="ðŸ“‹ CVE Monthly Report â€“ ${MONTH}"

          # Label anlegen falls noch nicht vorhanden
          gh label create "cve-monthly-report" --description "Monatlicher CVE-Sicherheitsbericht" --color "0075ca" 2>/dev/null || true

          # Duplikat-Schutz: prÃ¼fen ob diesen Monat schon ein Report existiert
          YEAR_MONTH=$(date -u +"%Y-%m")
          EXISTING=$(gh issue list --label "cve-monthly-report" --search "${YEAR_MONTH}" --state all --json number --jq 'length')
          if [ "$EXISTING" -gt "0" ]; then
            echo "Monthly Report fÃ¼r ${MONTH} existiert bereits â€“ Ã¼bersprungen."
            exit 0
          fi

          # Report-Datei lesen
          if [ -f security/reports/cve_report.md ]; then
            REPORT=$(cat security/reports/cve_report.md)
          else
            REPORT="âš ï¸ Kein CVE-Report vorhanden. Bitte den tÃ¤glichen CVE-Scan prÃ¼fen."
          fi

          # Issue-Body in temporÃ¤re Datei schreiben (vermeidet Shell-Quoting-Probleme)
          cat > /tmp/issue_body.md << ISSUEEOF
          # Monatlicher CVE-Sicherheitsbericht

          **Berichtszeitraum:** ${MONTH}
          **Erstellt am:** ${DATE}
          **Quelle:** TÃ¤glicher CVE-Scan via OSV API

          ---

          ${REPORT}

          ---
          **Assignee:** @Bheowulf
          *Automatisch erstellt von GitHub Actions (CVE Monthly Report Workflow).*
          *VollstÃ¤ndiger Report: [cve_report.md](https://github.com/${{ github.repository }}/blob/main/security/reports/cve_report.md)*
          ISSUEEOF

          # Issue erstellen
          gh issue create \
            --title "${TITLE}" \
            --body-file /tmp/issue_body.md \
            --label "cve-monthly-report" \
            --assignee "Bheowulf"
