<!--
  @file        index.html
  @description TARATool – Threat Analysis and Risk Assessment single-page application
  @author      Nico Peper
  @organization SCHUNK SE & Co. KG
  @copyright   2026 SCHUNK SE & Co. KG
  @license     GPL-3.0
-->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TARA Analysis Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <script type="module">
        import { Graphviz } from "https://cdn.jsdelivr.net/npm/@hpcc-js/wasm/dist/index.js";
        window.GraphvizLib = { Graphviz };
    </script>
</head>
<body>

    <div class="app-container">
        
        <div class="header-nav">
            <h1>TARA Tool</h1>
            <div class="action-nav">
                <button id="btnNewAnalysis" class="action-button small"><i class="fas fa-plus"></i> Neu</button>
                <select id="analysisSelector" style="width: 200px; padding:4px;">
                    </select>
            </div>
            <div class="utility-actions">
                <button id="btnImportAnalysis" class="action-button small"><i class="fas fa-file-import"></i> Import</button>
                <button id="btnExportAnalysis" class="action-button small"><i class="fas fa-file-export"></i> Export</button>
            </div>
        </div>

        <div class="main-content">
            
            <header class="main-header" style="padding: 10px 15px; margin-bottom: 10px;">
                <div style="width: 100%; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h2 id="analysisNameDisplay" style="margin:0; font-size:1.2em;">Analyse wählen oder neu starten</h2>
                        <div class="metadata" id="analysisMetadata" style="font-size:0.85em; color:#777; margin-top:2px;"></div>
                    </div>
                    <div class="header-actions">
                        <button id="btnSave" class="primary-button"><i class="fas fa-save"></i> Speichern</button>
                        <button id="btnShowVersionControl" class="action-button"><i class="fas fa-code-branch"></i> Versionen</button>
                        <button id="btnDeleteAnalysis" class="action-button dangerous"><i class="fas fa-trash"></i> Analyse löschen</button>
                    </div>
                </div>
            </header>

            <div class="tab-navigation">
                <button class="tab-button active" data-tab="tabOverview">Übersicht</button>
                <button class="tab-button" data-tab="tabAssets">Assets</button>
                <button class="tab-button" data-tab="tabDamageScenarios">Schadensszenarien</button>
                <button class="tab-button" data-tab="tabRiskAnalysis">Risikoanalyse</button>
                <button class="tab-button" data-tab="tabSecurityGoals">Security Ziele</button>
                <button class="tab-button" data-tab="tabResidualRisk">Restrisikoanalyse</button>
            </div>

            <div id="tabOverview" class="tab-content" style="display: block;">
                <div class="overview-actions" style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                    <button id="btnGenerateReport" class="action-button"><i class="fas fa-file-pdf"></i> Report (PDF)</button>
                </div>

                <div class="dashboard-grid">
                    <div class="stats-row">
                        <div class="stat-card" style="border-left-color: #3498db;">
                            <span class="stat-label">Assets</span>
                            <span class="stat-value" id="statAssetCount">0</span>
                        </div>
                        <div class="stat-card" style="border-left-color: #e67e22;">
                            <span class="stat-label">Szenarien</span>
                            <span class="stat-value" id="statDSCount">0</span>
                        </div>
                        <div class="stat-card" style="border-left-color: #f1c40f;">
                            <span class="stat-label">Risiken (Gesamt)</span>
                            <span class="stat-value" id="statRiskCount">0</span>
                        </div>
                        <div class="stat-card" style="border-left-color: #e74c3c; display: block; padding: 10px 15px;">
                            <div style="font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px;">Risikoverteilung</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 10px; font-size: 0.85em;">
                                <div style="color:#c0392b; font-weight:bold;">Kritisch: <span id="statCrit" style="color:#333;">0</span></div>
                                <div style="color:#e67e22; font-weight:bold;">Hoch: <span id="statHigh" style="color:#333;">0</span></div>
                                <div style="color:#f39c12; font-weight:bold;">Mittel: <span id="statMed" style="color:#333;">0</span></div>
                                <div style="color:#27ae60; font-weight:bold;">Niedrig: <span id="statLow" style="color:#333;">0</span></div>
                            </div>
                        </div>

                        <div class="stat-card" style="border-left-color: #8e44ad; display: block; padding: 10px 15px;">
                            <div style="font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px;">Risikoverteilung Restrisiko</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 10px; font-size: 0.85em;">
                                <div style="color:#c0392b; font-weight:bold;">Kritisch: <span id="statRRCrit" style="color:#333;">0</span></div>
                                <div style="color:#e67e22; font-weight:bold;">Hoch: <span id="statRRHigh" style="color:#333;">0</span></div>
                                <div style="color:#f39c12; font-weight:bold;">Mittel: <span id="statRRMed" style="color:#333;">0</span></div>
                                <div style="color:#27ae60; font-weight:bold;">Niedrig: <span id="statRRLow" style="color:#333;">0</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="panel" style="background: #fff; padding: 0;">
                        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Projektbeschreibung</h3>
                        <div class="meta-form-grid">
                            <div class="form-group">
                                <label>Analysename</label>
                                <input type="text" id="inputAnalysisName">
                            </div>
                            <div class="form-group">
                                <label>Autor / Verantwortlich</label>
                                <input type="text" id="inputAuthorName">
                            </div>
                            <div class="form-group">
                                <label>Systembeschreibung</label>
                                <textarea id="inputDescription" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Verwendungszweck (Intended Use)</label>
                                <textarea id="inputIntendedUse" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tabAssets" class="tab-content" style="display: none;">
                <div class="assets-controls" style="margin-bottom:15px;">
                    <button id="btnAddAsset" class="primary-button"><i class="fas fa-plus"></i> Asset hinzufügen</button>
                </div>
                <div id="assetsCardContainer" class="cards-grid"></div>
            </div>

            <div id="tabDamageScenarios" class="tab-content" style="display: none;">
                <div class="two-column-layout">
                    <div class="column-left" style="flex:1;">
                        <div class="panel">
                            <div class="panel-header" style="display:flex; justify-content:space-between;">
                                <h3 style="margin:0;">Verwaltung</h3>
                                <button id="btnAddDamageScenario" class="action-button small"><i class="fas fa-plus"></i> Neu</button>
                            </div>
                            <div id="dsManagementContainer" style="margin-top:10px;"></div>
                        </div>
                    </div>
                    <div class="column-right" style="flex:3;">
                        <div class="panel">
                            <h3 style="margin-top:0;">Schadensauswirkungsmatrix</h3>
                            <div id="dsMatrixContainer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tabRiskAnalysis" class="tab-content" style="display: none;">
                <div class="panel">
                    <h3>Risikoanalyse & Angriffsbäume</h3>
                    <div id="riskAnalysisContainer"></div>
                </div>
            </div>

            <div id="tabSecurityGoals" class="tab-content" style="display: none;">
                <div class="assets-controls" style="margin-bottom:15px;">
                    <button id="btnAddSecurityGoal" class="primary-button"><i class="fas fa-plus"></i> Security Ziel hinzufügen</button>
                </div>
                <div id="securityGoalsScrollArea" class="scroll-area">
                    <div id="securityGoalsCardContainer" class="cards-grid"></div>
                </div>
            </div>

            <div id="tabResidualRisk" class="tab-content" style="display: none;">
                <div class="panel">
                    <h3>Restrisikoanalyse</h3>
                    <p style="color:#666; margin-top:0;">Erfassen Sie für jede Auswirkung eine Risikomaßnahme sowie Anmerkung und Security Maßnahme. Bei <b>Mitigiert</b> ist zusätzlich eine Neubewertung (K/S/T/U) erforderlich. Die Risikoanalyse bleibt dabei unverändert.</p>
                    <div id="residualRiskScrollArea" class="scroll-area">
                        <div id="residualRiskContainer"></div>
                    </div>
                </div>
            </div>

        
        <footer class="status-bar" style="background: #333; color: #fff; padding: 4px 20px; font-size: 0.8em; margin-top: auto;">
            <span id="statusBarMessage">Bereit.</span>
        </footer>
    </div>

    <div id="assetModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" id="closeAssetModal">&times;</span>
            <h2 id="assetModalTitle">Neues Asset</h2>
            <form id="assetForm">
                <input type="hidden" id="assetIdField">
                <div class="form-group">
                    <label>Name</label> <input type="text" id="assetName" required>
                </div>
                <div class="form-group">
                    <label>Typ</label> <input type="text" id="assetType">
                </div>
                <div class="form-group">
                    <label>Beschreibung</label> <textarea id="assetDescription" rows="3"></textarea>
                </div>
                <fieldset style="border:1px solid #ddd; padding:10px;">
                    <legend>Schutzbedarf (CIA)</legend>
                    <div class="cia-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                        <div>
                            <label>Confidentiality</label><br>
                            <label><input type="radio" name="confidentiality" value="I"> I</label>
                            <label><input type="radio" name="confidentiality" value="II"> II</label>
                            <label><input type="radio" name="confidentiality" value="III"> III</label>
                        </div>
                        <div>
                            <label>Integrity</label><br>
                            <label><input type="radio" name="integrity" value="I"> I</label>
                            <label><input type="radio" name="integrity" value="II"> II</label>
                            <label><input type="radio" name="integrity" value="III"> III</label>
                        </div>
                        <div>
                            <label>Availability</label><br>
                            <label><input type="radio" name="authenticity" value="I"> I</label>
                            <label><input type="radio" name="authenticity" value="II"> II</label>
                            <label><input type="radio" name="authenticity" value="III"> III</label>
                        </div>
                    </div>
                </fieldset>
                <button type="submit" class="primary-button" style="margin-top:15px;">Speichern</button>
            </form>
        </div>
    </div>

    <div id="damageScenarioModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" id="closeDamageScenarioModal">&times;</span>
            <h2 id="dsModalTitle">Schadensszenario</h2>
            <form id="damageScenarioForm">
                <input type="hidden" id="dsIdField">
                <div class="form-group"><label>Name</label><input type="text" id="dsName" required></div>
                <div class="form-group"><label>Kurzbeschreibung</label><input type="text" id="dsShort" required maxlength="10"></div>
                <div class="form-group"><label>Beschreibung</label><textarea id="dsDescription" rows="3"></textarea></div>
                <button type="submit" class="primary-button">Speichern</button>
            </form>
        </div>
    </div>

    <div id="securityGoalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" id="closeSecurityGoalModal">&times;</span>
            <h2 id="securityGoalModalTitle">Security Ziel</h2>
            <form id="securityGoalForm">
                <input type="hidden" id="sgIdField">
                <div class="form-group"><label>Name</label><input type="text" id="sgName" required></div>
                <div class="form-group"><label>Beschreibung</label><textarea id="sgDescription" rows="4"></textarea></div>
                <div class="form-group">
                    <label>Referenzierte Angriffsziel(e) (Root)</label>
                    <select id="sgRootRefs" multiple size="6" style="width:100%;"></select>
                    <div style="font-size:0.8em; color:#777; margin-top:4px;">Mehrfachauswahl: Strg/⌘</div>
                </div>
                <button type="submit" class="primary-button">Speichern</button>
            </form>
        </div>
    </div>

    <div id="attackTreeModal" class="modal large-modal" style="display: none;">
        <div class="modal-content large-content">
            <span class="close-button" id="closeAttackTreeModal">&times;</span>

            <form id="attackTreeForm">
                <input type="hidden" id="at_id" name="at_id">
                <input type="hidden" id="use_deep_tree" name="use_deep_tree" value="false">
                <input type="hidden" id="tree_depth" name="tree_depth" value="1">
                <input type="hidden" id="use_second_intermediate" name="use_second_intermediate" value="false">

                <div class="at-card at-root-card" style="background:#f0f0f0; border-color:#ccc; margin-bottom:10px;">
                    <div class="at-card-header">
                        <strong style="white-space:nowrap;">Angriffsziel (Root):</strong>
                        <input type="text" name="at_root" placeholder="z.B. Manipulation der Firmware" required class="at-root-input" style="flex-grow:1; font-weight:bold;"
                               title="Oberstes Angriffsziel (Root)">
                        <div id="at_root_kstu_summary" class="node-stats-box at-node-summary" style="width:220px; margin-top:0;"></div>
                    </div>
                    <div class="at-card-actions">
                        <button type="button" id="btnAddAttackPath" class="action-button small"
                                title="Legt einen neuen Angriffspfad (Kindknoten unter Root) an.">
                            <i class="fas fa-plus"></i> Angriffspfad anlegen
                        </button>
                        <span class="at-hint" title="Innerhalb eines Pfads kannst du Auswirkungen (Blätter) oder Zwischenpfade anlegen.">
                            <i class="fas fa-info-circle"></i> Baum wächst dort, wo du klickst.
                        </span>
                    </div>
                </div>

                <div id="atTreeEditorV2" class="at-tree-editor"></div>

                <div class="modal-actions" style="margin-top: 20px; display:flex; justify-content:space-between;">
                    <button type="button" id="btnDeleteAttackTree" class="action-button dangerous" style="display:none;">Löschen</button>
                    <button type="submit" class="primary-button large">Speichern &amp; Schließen</button>
                </div>
            </form>

            <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 15px;">
                <h4 style="margin:0 0 10px 0;">DOT Vorschau</h4>
                <button type="button" onclick="renderCurrentTreePreview()" class="action-button small"
                        title="Erzeugt eine DOT Vorschau aus dem aktuellen Editor-Inhalt.">
                    <i class="fas fa-eye"></i> Generieren
                </button>
                <div id="graph-preview-container" style="margin-top: 10px; overflow: auto; max-height: 400px; border: 1px solid #eee;"></div>
            </div>
        </div>
    </div>

    <div id="newAnalysisModal" class="modal" style="display:none;">
        <div class="modal-content"><span class="close-button" id="closeNewAnalysisModal">&times;</span>
        <h2>Neue Analyse</h2>
        <form id="newAnalysisForm">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="newAnalysisName" required>
            </div>

            <div class="form-group" style="display:flex; gap:10px; align-items:center;">
                <button type="button" id="btnToggleCopyExistingAnalysis" class="action-button small">Kopieren</button>
            </div>

            <div class="form-group" id="copyExistingAnalysisGroup" style="display:none;">
                <label>Vorlage</label>
                <select id="copyExistingAnalysisSelect"></select>
            </div>

            <button type="submit" class="primary-button">Erstellen</button>
        </form>
        </div>
    </div>
    <div id="importAnalysisModal" class="modal" style="display:none;">
        <div class="modal-content"><span class="close-button" id="closeImportAnalysisModal">&times;</span><h2>Import</h2><input type="file" id="importFileInput" accept=".json"><div style="margin-top:10px;"><button class="primary-button" onclick="executeImport()">Importieren</button></div></div>
    </div>
    

    <!-- Restrisikoanalyse Modal (Bearbeiten) -->
    <div id="residualRiskModal" class="modal large-modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button" id="closeResidualRiskModal">&times;</span>
            <h2 id="residualRiskModalTitle">Restrisiko bearbeiten</h2>
            <div id="residualRiskModalBody"></div>
            <div style="text-align:right; margin-top:15px;">
                <button id="btnCloseResidualRiskModalFooter" class="primary-button">Fertig</button>
            </div>
        </div>
    </div>

    <div id="versionControlModal" class="modal" style="display:none;">
        <div class="modal-content large-content">
            <span class="close-button" id="closeVersionControlModal">&times;</span>
            <h2>Versionen</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Ver.</th>
                        <th>Datum</th>
                        <th>Autor</th>
                        <th>Kommentar</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
            <div style="margin-top:10px;">
                <button class="primary-button" onclick="openVersionCommentModal()">Neue Version</button>
            </div>
        </div>
    </div>
    <div id="versionCommentModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button" id="closeVersionCommentModal">&times;</span>
            <h2>Neue Version</h2>
            <div style="color:#666; font-size:0.9em; margin-bottom:8px;">Aktuelle Version: <b id="currentVersionInModal">-</b></div>
            <div class="form-group" style="margin-bottom:10px;">
                <label style="font-weight:600;">Versionstyp</label>
                <div style="display:flex; gap:14px; flex-wrap:wrap; margin-top:6px;">
                    <label style="display:flex; gap:6px; align-items:center;">
                        <input type="radio" name="versionType" value="minor" checked>
                        Inkrementell (x.y → x.(y+1))
                    </label>
                    <label style="display:flex; gap:6px; align-items:center;">
                        <input type="radio" name="versionType" value="major">
                        Hauptversion ((x).y → (x+1).0)
                    </label>
                </div>
            </div>
            <form id="versionCommentForm">
                <label style="font-weight:600;">Kommentar</label>
                <textarea id="inputVersionComment" required placeholder="Kurz beschreiben, was sich geändert hat..."></textarea>
                <div style="text-align:right; margin-top:10px;">
                    <button type="submit" class="primary-button">Speichern</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirmationModal" class="modal" style="display:none;">
        <div class="modal-content small">
            <span class="close-button" id="closeConfirmationModal">&times;</span>
            <h2 id="confirmationTitle">Bestätigung</h2>
            <p id="confirmationMessage">Sicher?</p>
            <div style="text-align:right;">
                <button id="btnCancelConfirmation" class="action-button">Abbrechen</button> 
                <button id="btnConfirmAction" class="primary-button">OK</button>
            </div>
        </div>
    </div>
    
    <div id="toastContainer"></div>

    <!-- Core -->
    <script src="js/core/globals.js"></script>
    <script src="js/core/utils.js"></script>
    <script src="js/core/analysis_core.js"></script>

    <!-- Modules -->
    <script src="js/modules/assets.js"></script>
    <script src="js/modules/damage_scenarios.js"></script>
    <script src="js/modules/impact_matrix.js"></script>
    <script src="js/modules/security_goals.js"></script>
    <script src="js/modules/risk_analysis.js"></script>

    <!-- Attack Tree -->
    <script src="js/attack_tree/attack_tree_ui.js"></script>
    <script src="js/attack_tree/attack_tree_editor_v2.js"></script>
    <script src="js/attack_tree/attack_tree_calc.js"></script>
    <script src="js/attack_tree/dot_export.js"></script>

    <!-- Versioning -->
    <script src="js/modules/versioning.js"></script>

    <!-- Report (PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/report/report_pdf_helpers.js"></script>
    <script src="js/report/report_pdf_builder.js"></script>
    <script src="js/report/report_export.js"></script>

    <!-- Residual Risk -->
    <script src="js/residual_risk/residual_risk_data.js"></script>
    <script src="js/residual_risk/residual_risk_ui.js"></script>

    <!-- Init (muss zuletzt geladen werden) -->
    <script src="js/core/init.js"></script>
</body>
</html>